## X-BASIC 外部関数ファイル読み込み機能について

X-BASIC で用いられている外部関数ファイル (*.FNC) の読み込みに対応しました。
読み込んだ外部関数は MicroPython の関数として、Python のコードから直接呼び出すことができるようになります。

### 使用方法

#### 外部関数ファイルのロードと呼び出し

X-BASIC の外部関数ファイルのファイル名を与えて `x68k.loadfnc()` 関数を呼ぶことで、ファイルに含まれる外部関数を Python から呼び出せるようになります。

```
>>> import x68k
>>> x68k.loadfnc('STICK.FNC')
```
X-BASIC 付属の外部関数ファイル `STICK.FNC` をロードして、そこに含まれる関数 `stick()` と `strig()` が使えるようになります。

外部関数を Python から呼び出す際の引数は、X-BASIC の基本データ型 `int`, `char`, `float`, `str` については Python のデータ型を各外部関数が要求する型に変換して渡します。
```
>>> stick(1)      # 引数はint型のスティック番号
0

>>> stick(0)      # エラーが起きると外部関数の返すエラーメッセージを表示する
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ValueError: 無効なスティック番号を指定しました
```

#### 配列引数の渡し方

配列を引数に取る外部関数を呼び出す際は、引数に X-BASIC 互換の配列型 `x68k.xarray` のオブジェクトを使用します。

以下に、外部関数ファイル `MUSIC.FNC` に含まれる関数 `m_vget()` を MicroPython から呼び出す例を示します。
この関数は第 2 引数に (4,10) の char 型2次元配列を取りますが、X-BASIC は配列定義の際にインデックスの最大値を指定する一方で Python では配列の要素数を指定するため、配列定義の際の引数が 1 大きくなることに注意してください。
```
>>> x68k.loadfnc('MUSIC.FNC')

>>> a = x68k.xarray_char(5,11)    # X-BASIC の dim char a(4,10) に相当
>>> m_vget(1, a)                  # 音色番号 1 の音色データを配列変数 a に取得する
0

>>> a
xarray('B', [[58, 15, 2, 0, 220, 0, 0, 0, 0, 3, 0], [28, 4, 0, 5, 1, 37, 2, 1, 7, 0, 0], [22, 9, 1, 2, 1, 47, 2, 12, 0, 0, 0], [29, 4, 3, 6, 1, 37, 1, 3, 3, 0, 0], [15, 7, 0, 5, 10, 0, 2, 1, 0, 0, 1]])
```

#### 参照渡し引数の渡し方

一部の外部関数には、引数として渡した変数の中に結果を返すものがあります(参照渡し)。
こうした関数を呼び出す場合は、要素数 1 の `x68k.xarray` 型配列を渡すことで結果を受け取ることができます。

変数を参照渡ししている外部関数の例として、`MOUSE.FNC` に含まれる `mspos()` を MicroPython から呼び出す例を示します。
この関数は、2 つの引数で参照渡しされる int 型変数にマウスカーソルの X, Y 座標を返します。
```
>>> x68k.loadfnc('MOUSE.FNC')

>>> x = x68k.xarray_int()         # 参照渡しのために、要素数 1 の配列を作成
>>> y = x68k.xarray_int()
>>> mspos(x, y)
0

>>> x[0]                          # 配列なので要素の参照にはインデックスが必要
489
>>> y[0]
217
```

### `x68k` ライブラリの外部関数読み込み機能

* `x68k.loadfnc(file [,flag])`
  * X-BASIC の外部関数ファイル (*.FNC) を読み込みます。
    * `file` には読み込むファイルのファイル名を指定します。
    * 省略可能な `flag` で、ファイルを空きメモリのどこにロードするかを指定します。`True` を指定するまたはオプションを省略すると空きメモリの末尾から、`False` を指定すると先頭からロードします。

#### クラス `xarray` -- X-BASIC と互換の配列型

* class `x68k.xarray(typecode [,sub1][,sub2][,iterable])`
  * X-BASIC 外部関数の引数として用いることができる配列オブジェクトを構築します。
  * MicroPython/Python 標準ライブラリの [array.array](https://micropython-docs-ja.readthedocs.io/ja/latest/library/array.html#array.array) 型と類似の機能ですが、以下の点が異なります。
    * `array.array` 型で作れるのは1次元配列のみですが、`x68k.xarray` 型は2次元配列をサポートします。
    * 配列の要素数は作成した時点から変更できません。`array.array` 型における `append()` や `extend()` に相当する機能は存在しません。
    * 配列同士の演算、比較などはサポートしていません。
  * `typecode` には作成する配列の各要素のデータ型を指定します。
    [array.array()](https://micropython-docs-ja.readthedocs.io/ja/latest/library/array.html#array.array) における `typecode` 引数と同じです。
  * `sub1`, `sub2` には作成する配列の要素数を指定します。`sub1` のみを指定すると1次元配列、`sub1`, `sub2` の両方を指定すると2次元配列となります。
    * X-BASIC での配列定義ではインデックスの最大値を指定するのに対して、`x68k.xarray` では要素数を指定することに注意が必要です。
      * X-BASIC での `dim int a(9)` に相当するのは `a = x68k.xarray('l', 10)` になります。
      * どちらも `a(0)`～`a(9)` (Pythonでは `a[0]`～`a[9]`) が作成されます。
  * `iterable` には配列の初期値を与えます。
    * `sub1`, `sub2` を与えずに `iterable` を与えた場合は、`iterable` の長さから求めた要素数が用いられます。
    * `iterable` に list 型が与えられた場合、list 型の各要素が list 型であれば2次元配列が作成されます。
    * `sub1` や `sub2` と `iterable` の両方を与えた場合、`iterable` の長さと `sub1`, `sub2` の指定に矛盾があるとエラーになります。
  * `sub1`, `sub2`, `iterable` のすべてを省略すると、要素数 1 の空の配列が作成されます。

以下の関数でも配列を作成することができます。

* `x68k.xarray_char([sub1][,sub2][,iterable])`
  * 8ビット符号なし整数配列を作成します。`typecode` に `'B'` を指定して `x68k.xarray()` を呼ぶのと同じです。
* `x68k.xarray_int([sub1][,sub2][,iterable])`
  * 32ビット符号付き整数配列を作成します。`typecode` に `'l'` を指定して `x68k.xarray()` を呼ぶのと同じです。
* `x68k.xarray_float([sub1][,sub2][,iterable])`
  * 倍精度浮動小数点数配列を作成します。`typecode` に `'d'` を指定して `x68k.xarray()` を呼ぶのと同じです。
    * (X-BASICの `float` は倍精度浮動小数点数です)

作成したオブジェクトには以下のメソッドが使用できます。

* `xarray.shape()`
  * 配列の要素数を持つタプルを返します。
  * 1次元配列の場合は `(sub1,)`、2次元配列の場合は `(sub1, sub2)` というタプルが返ります。
* `xarray.list([flag])`
  * 配列から list 型配列を作って返します。
  * 2次元配列に対して実行した場合、`flag` を省略または `False` を指定すると、作られる list 型配列も2次元となります(list型配列のリスト)。`True` を指定すると 配列の全要素を1列に並べたリストが作られます。
  * 例:
    ```
    >>> a = x68k.xarray_int([[1, 2, 3], [4, 5, 6]])   # 2×3 の2次元配列
    
    >>> a.list()
    [[1, 2, 3], [4, 5, 6]]    # 2次元配列の構造が list 型にも反映される 

    >>> a.list(True)
    [1, 2, 3, 4, 5, 6]        # 全要素を並べた list 型が作られる
    ```

### 制約事項

* 一度ロードした外部関数ファイルはアンロードできません。
* ロードした外部関数ファイルに既に存在する関数名が含まれている場合、関数定義が上書きされます。
* 既にロードした外部関数ファイルを再度ロードするとすべての関数定義が上書きされますが、古い外部関数ファイルのメモリ領域は MicroPython が終了するまで解放されません。
* 外部関数ファイルのインフォメーションテーブルにある、初期化/終了/RUN/END/中断など、各種イベント発生時の処理ルーチンの呼び出しは行っていません。
